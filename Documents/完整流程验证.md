# 完整流程验证

## ✅ 流程检查完成

已检查并优化了完整流程，确保所有场景切换和初始化都正确工作。

## 流程验证

### 1. 启动流程 ✅

```
Unity 启动
    │
    ├─→ Client.Start()
    │       ├─→ GameManager.Instance (初始化系统)
    │       ├─→ GameModeManager.Instance (初始化网络层)
    │       └─→ 检测场景类型，不干预初始化
    │
    └─→ GameManager.Start()
            ├─→ Initialize() (初始化系统)
            └─→ AutoInitializeScene() (如果启用)
                    ├─→ 检测到 Lobby → InitializeLobby()
                    └─→ 检测到 Main → StartGame()
```

**状态**: ✅ 正常

### 2. 主菜单 → 大厅 ✅

```
MainMenuManager.OnStartGameClicked()
    └─→ SceneManager.Instance.LoadLobby()
            └─→ 场景切换完成
                └─→ SceneManager.OnSceneLoaded()
                    └─→ GameManager.Instance.InitializeLobby()
                        └─→ 检查状态，避免重复初始化 ✅
```

**状态**: ✅ 正常（有防重复检查）

### 3. 大厅 → 游戏关卡 ✅

```
GameManager.OnStartGameFromLobby()
    ├─→ GameModeManager.SetMode() (设置游戏模式)
    └─→ SceneManager.Instance.LoadGameLevel()
            └─→ 场景切换完成
                └─→ SceneManager.OnSceneLoaded()
                    └─→ GameManager.Instance.StartGame()
                        └─→ 检查状态，避免重复初始化 ✅
```

**状态**: ✅ 正常（有防重复检查）

### 4. 游戏关卡 → 大厅（返回）✅

```
GameManager.ReturnToLobby()
    ├─→ ChangeState(GameState.Lobby)
    └─→ SceneManager.Instance.LoadLobby()
            └─→ 场景切换完成
                └─→ SceneManager.OnSceneLoaded()
                    └─→ GameManager.Instance.InitializeLobby()
                        └─→ 检查状态，避免重复初始化 ✅
```

**状态**: ✅ 正常（有防重复检查）

### 5. GameModeManager 集成 ✅

#### 旧流程（直接启动，不通过大厅）
```
GameModeManager.StartGame()
    └─→ StartOfflineGame()
        └─→ InitializeGame()
            └─→ 检查场景类型
                └─→ 如果是游戏关卡场景 → GameManager.StartGame()
```

**状态**: ✅ 正常（已添加场景检查，避免冲突）

#### 新流程（通过大厅）
```
GameManager.OnStartGameFromLobby()
    └─→ SceneManager.LoadGameLevel()
        └─→ SceneManager.OnSceneLoaded()
            └─→ GameManager.StartGame()
```

**状态**: ✅ 正常

## 防重复初始化机制

### GameManager 防重复检查

1. **InitializeLobby()**:
   ```csharp
   if (_currentState == GameState.Lobby) return; // 已初始化，跳过
   ```

2. **StartGame()**:
   ```csharp
   if (_currentState == GameState.Playing) return; // 已初始化，跳过
   ```

3. **AutoInitializeScene()**:
   ```csharp
   // 检查 SceneManager 是否正在切换场景
   if (sceneManager.IsTransitioning) return; // SceneManager 会处理，跳过
   
   // 检查当前状态
   if (_currentState == GameState.Lobby) return; // 已初始化，跳过
   if (_currentState == GameState.Playing) return; // 已初始化，跳过
   ```

### SceneManager 防重复检查

```csharp
// 检查 GameManager 当前状态
if (GameManager.Instance.CurrentState != GameState.Lobby) {
    GameManager.Instance.InitializeLobby();
}

if (GameManager.Instance.CurrentState != GameState.Playing) {
    GameManager.Instance.StartGame();
}
```

### GameModeManager 场景检查

```csharp
// 只在游戏关卡场景时才初始化
if (currentSceneName != "Main" && !currentSceneName.Contains("Level")) {
    return; // 不是游戏关卡场景，跳过
}
```

## 场景切换时序

### 通过 SceneManager 切换

```
1. SceneManager.LoadScene()
2. 场景加载中...
3. SceneManager.OnSceneLoaded() 触发
4. GameManager 检查状态并初始化
5. 完成
```

### 直接打开场景（独立测试）

```
1. Unity 直接打开场景
2. GameManager.Start() 触发
3. GameManager.AutoInitializeScene() 检测场景
4. GameManager 初始化场景
5. 完成
```

## 关键优化点

### ✅ 已优化

1. **AutoInitializeScene() 添加 SceneManager 检查**
   - 如果 SceneManager 正在切换场景，跳过自动初始化
   - 避免和 SceneManager 冲突

2. **GameModeManager.InitializeGame() 添加场景检查**
   - 只在游戏关卡场景时才初始化
   - 避免在错误场景初始化

3. **所有初始化方法都有防重复检查**
   - InitializeLobby() 检查状态
   - StartGame() 检查状态
   - AutoInitializeScene() 检查状态和 SceneManager

## 测试场景

### 场景 1: 完整流程测试
```
1. 启动游戏 → 主菜单
2. 点击"开始游戏" → 大厅
3. 选择关卡 → 点击"开始游戏" → 游戏关卡
4. 测试返回大厅功能 → 大厅
5. 测试返回主菜单功能 → 主菜单
```

**预期**: ✅ 所有场景切换正常，无重复初始化

### 场景 2: 独立测试 - 大厅
```
1. Unity 中直接打开 Lobby 场景
2. 点击 Play
3. 自动初始化大厅场景
```

**预期**: ✅ 自动初始化，所有功能可用

### 场景 3: 独立测试 - 游戏关卡
```
1. Unity 中直接打开 Main 场景
2. 点击 Play
3. 自动初始化游戏关卡场景
```

**预期**: ✅ 自动初始化，所有功能可用

### 场景 4: GameModeManager 直接启动（旧流程）
```
1. 在游戏关卡场景中使用 GameStarter
2. 调用 GameModeManager.StartGame()
3. 应该正常初始化
```

**预期**: ✅ 正常初始化，不冲突

## 总结

### ✅ 正常工作的流程

1. ✅ 启动流程
2. ✅ 主菜单 → 大厅
3. ✅ 大厅 → 游戏关卡
4. ✅ 游戏关卡 → 大厅（返回）
5. ✅ 独立测试模式
6. ✅ 防重复初始化

### ⚠️ 注意事项

1. **场景命名规范**:
   - 大厅场景：名称包含 "Lobby"
   - 关卡场景：名称包含 "Main"、"Level" 或 "Game"
   - 主菜单：名称包含 "Menu"

2. **初始化顺序**:
   - Client 先初始化系统
   - GameManager 再自动检测场景
   - SceneManager 在场景切换时初始化

3. **状态管理**:
   - 所有初始化方法都有状态检查
   - 避免重复初始化

## 建议

1. ✅ **已完成**: 添加了防重复初始化检查
2. ✅ **已完成**: 优化了 AutoInitializeScene() 逻辑
3. ✅ **已完成**: GameModeManager 添加了场景检查
4. ✅ **已完成**: SceneManager 添加了状态检查

所有流程现在都应该正常工作！


