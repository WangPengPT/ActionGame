# 游戏流程说明

## 概述

游戏采用三阶段流程：**主界面 → 玩家大厅 → 游戏关卡**

## 流程架构

```
┌─────────────┐
│  主界面      │  (MainMenu)
│  - 开始游戏  │
│  - 设置      │
│  - 存档/读档 │
│  - 退出游戏  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  玩家大厅    │  (Lobby) - 本地，无需联网
│  - 选择关卡  │
│  - 选择模式  │  (单机/联网)
│  - 准备开始  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  游戏关卡    │  (GameLevel)
│  - 单机模式  │  (Offline)
│  - 联网模式  │  (LAN/Relay)
└─────────────┘
```

## 场景管理

### 场景类型

1. **MainMenu** - 主界面场景
   - 场景名: `MainMenu`
   - 管理器: `MainMenuManager`
   - 功能: UI界面，无游戏逻辑

2. **Lobby** - 玩家大厅场景
   - 场景名: `Lobby`
   - 管理器: `LobbyManager`
   - 功能: 
     - 玩家角色（可移动和交互）
     - NPC交互（商店、升级、关卡选择）
     - 关卡选择、模式选择
   - **注意**: 
     - 大厅是本地功能，不需要联网
     - 这是一个可交互的游戏场景，不是纯UI界面
     - 玩家可以在大厅中自由移动，与NPC交互

3. **GameLevel** - 游戏关卡场景
   - 场景名: `Main` (当前游戏场景)
   - 管理器: `GameManager`
   - 功能: 实际游戏玩法
   - 模式: 单机或联网

### 场景切换

使用 `SceneManager` 统一管理场景切换：

```csharp
// 切换到主界面
SceneManager.Instance.LoadMainMenu();

// 切换到大厅
SceneManager.Instance.LoadLobby();

// 加载游戏关卡
SceneManager.Instance.LoadGameLevel(levelId, gameMode);
```

## 组件说明

### 1. SceneManager (场景管理器)

**位置**: `Assets/Code/GamePlay/Manager/SceneManager.cs`

**职责**:
- 统一管理场景切换
- 处理场景加载进度
- 触发场景切换事件

**主要方法**:
- `LoadMainMenu()` - 加载主界面
- `LoadLobby()` - 加载大厅
- `LoadGameLevel(int levelId, GameModeType mode)` - 加载关卡

### 2. MainMenuManager (主界面管理器)

**位置**: `Assets/Code/GamePlay/Manager/MainMenuManager.cs`

**职责**:
- 管理主界面UI
- 处理主界面按钮事件
- 显示设置面板、存档面板

**功能**:
- ✅ 开始游戏 → 进入大厅
- ✅ 设置 → 打开设置面板
- ✅ 存档/读档 → 打开存档面板
- ✅ 退出游戏

**UI组件**:
- `_startButton` - 开始游戏按钮
- `_settingsButton` - 设置按钮
- `_loadButton` - 读档按钮
- `_quitButton` - 退出按钮
- `_settingsPanel` - 设置面板
- `_saveLoadPanel` - 存档面板

### 3. LobbyManager (大厅管理器)

**位置**: `Assets/Code/GamePlay/Manager/LobbyManager.cs`

**职责**:
- 管理玩家大厅场景（可交互的游戏场景）
- 创建玩家角色（可移动和交互）
- 生成和管理NPC（商人、铁匠、升级师等）
- 显示关卡列表
- 选择游戏模式（单机/联网）
- 开始游戏

**功能**:
- ✅ 创建玩家角色（可在大厅中移动）
- ✅ 生成NPC（商人、铁匠、训练师、任务NPC等）
- ✅ NPC交互（商店、升级、关卡选择等）
- ✅ 显示关卡列表（UI面板）
- ✅ 选择关卡
- ✅ 选择游戏模式（单机/联网）
- ✅ 开始游戏 → 加载关卡
- ✅ 返回主菜单

**NPC功能**:
- **商人 (Merchant)**: 打开商店，购买物品
- **铁匠 (Blacksmith)**: 装备强化/升级（待实现）
- **训练师 (Trainer)**: 技能升级（待实现）
- **任务NPC (QuestGiver)**: 打开关卡选择面板
- **普通NPC (Normal)**: 显示对话

**关卡配置**:
```csharp
public class LevelInfo
{
    public int LevelId;              // 关卡ID
    public string LevelName;          // 关卡名称
    public string Description;        // 描述
    public Sprite PreviewImage;       // 预览图
    public bool IsUnlocked;           // 是否解锁
    public bool SupportMultiplayer;   // 是否支持多人
}
```

**默认关卡**:
1. 训练场 - 新手训练，仅单机
2. 废弃工厂 - 单人/多人
3. 城市废墟 - 多人合作（默认锁定）

### 4. GameManager (游戏管理器)

**位置**: `Assets/Code/GamePlay/Manager/GameManager.cs`

**职责**:
- 管理游戏逻辑
- 处理游戏状态
- 创建玩家、NPC、物品等

**游戏状态**:
- `Initializing` - 初始化中
- `MainMenu` - 主菜单
- `Lobby` - 玩家大厅 ⭐ 新增
- `Playing` - 游戏中
- `Paused` - 暂停
- `GameOver` - 游戏结束
- `Victory` - 胜利

## 使用流程

### 开发阶段

1. **创建场景**:
   - `MainMenu.unity` - 主界面场景
   - `Lobby.unity` - 大厅场景
   - `Main.unity` - 游戏关卡场景（已存在）

2. **设置场景**:
   - 在主界面场景中添加 `MainMenuManager` 组件
   - 在大厅场景中添加 `LobbyManager` 组件
   - 在关卡场景中添加 `GameStarter` 组件（可选）

3. **配置UI和场景**:
   - 主界面: 绑定按钮到 `MainMenuManager`
   - 大厅: 
     - 创建关卡按钮列表，绑定到 `LobbyManager`
     - 配置NPC生成位置（`_lobbyNPCs`）
     - 设置玩家生成位置（`_playerSpawnPosition`）
     - 配置关卡选择面板（`_levelSelectPanel`）

### 运行流程

1. **启动游戏**:
   - 默认加载主界面场景
   - `Client` 初始化系统
   - `MainMenuManager` 初始化主界面

2. **主界面操作**:
   - 点击"开始游戏" → 切换到大厅场景
   - 点击"设置" → 打开设置面板
   - 点击"读档" → 打开存档面板
   - 点击"退出" → 退出游戏

3. **大厅操作**:
   - **玩家移动**: WASD移动，与NPC交互（E键）
   - **NPC交互**:
     - 商人 → 打开商店购买物品
     - 铁匠 → 打开装备强化界面（待实现）
     - 训练师 → 打开技能升级界面（待实现）
     - 任务NPC → 打开关卡选择面板
   - **关卡选择**: 
     - 通过UI按钮打开关卡选择面板
     - 或与任务NPC交互打开
   - 选择游戏模式（单机/联网）
   - 点击"开始游戏" → 加载对应关卡
   - 点击"返回" → 返回主界面

4. **关卡游戏**:
   - 根据选择的模式启动（单机/联网）
   - `GameManager` 创建玩家、NPC等
   - 开始游戏

## 注意事项

1. **大厅是本地功能**
   - 大厅场景不需要联网
   - 玩家可以在大厅中自由移动和交互
   - NPC、商店、升级等功能都在本地完成
   - 关卡选择、模式选择都在本地完成
   - 只有进入关卡后才需要联网（如果选择联网模式）

2. **大厅场景配置**
   - 需要在Inspector中配置NPC生成位置（`_lobbyNPCs`）
   - 可以配置玩家生成位置（`_playerSpawnPosition`）
   - NPC会自动从Excel配置加载（通过NPCConfigId）
   - 如果没有配置NPC，会使用默认NPC配置

2. **场景切换**
   - 使用 `SceneManager` 统一管理
   - 支持异步加载和进度显示
   - 自动初始化对应场景的管理器

3. **游戏状态**
   - `GameManager` 统一管理游戏状态
   - 主界面、大厅、关卡都有对应的状态
   - 状态切换会触发事件

4. **关卡配置**
   - 关卡信息在 `LobbyManager` 中配置
   - 支持关卡解锁系统
   - 支持关卡预览图

## 扩展功能

### 待实现功能

- [ ] 设置面板功能（音量、画质等）
- [ ] 存档/读档系统
- [ ] 关卡解锁系统（基于进度）
- [ ] 关卡预览图显示
- [ ] 联网模式房间创建/加入
- [ ] 关卡进度保存
- [ ] 装备强化/升级系统（铁匠功能）
- [ ] 技能升级系统（训练师功能）
- [ ] 商店UI界面完善
- [ ] NPC对话系统完善

### 建议改进

1. **关卡数据配置化**
   - 使用 ScriptableObject 配置关卡数据
   - 支持在 Unity Editor 中编辑

2. **UI系统优化**
   - 使用 UI 框架（如 Unity UI Toolkit）
   - 支持动画过渡效果

3. **存档系统**
   - 实现关卡进度存档
   - 实现玩家数据存档

